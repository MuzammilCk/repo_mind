============================= test session starts =============================
platform win32 -- Python 3.13.5, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\THINKPAD L13\AppData\Local\Programs\Python\Python313\python.exe
cachedir: .pytest_cache
rootdir: D:\projects\cli
configfile: pytest.ini
plugins: anyio-4.12.0, langsmith-0.4.49, asyncio-1.3.0, cov-7.0.0, mock-3.15.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 19 items

tests/test_codeql_service.py::TestCodeQLService::test_severity_mapping PASSED [  5%]
tests/test_codeql_service.py::TestCodeQLService::test_verify_codeql_success PASSED [ 10%]
tests/test_codeql_service.py::TestCodeQLService::test_verify_codeql_not_installed PASSED [ 15%]
tests/test_codeql_service.py::TestCodeQLService::test_verify_codeql_timeout PASSED [ 21%]
tests/test_codeql_service.py::TestCodeQLService::test_parse_sarif_basic PASSED [ 26%]
tests/test_codeql_service.py::TestCodeQLService::test_parse_sarif_severity_mapping FAILED [ 31%]
tests/test_codeql_service.py::TestCodeQLService::test_parse_sarif_file_paths FAILED [ 36%]
tests/test_codeql_service.py::TestCodeQLService::test_parse_sarif_line_numbers FAILED [ 42%]
tests/test_codeql_service.py::TestCodeQLService::test_parse_sarif_recommendations PASSED [ 47%]
tests/test_codeql_service.py::TestCodeQLService::test_parse_empty_sarif PASSED [ 52%]
tests/test_codeql_service.py::TestCodeQLService::test_parse_malformed_sarif PASSED [ 57%]
tests/test_codeql_service.py::TestCodeQLService::test_count_severities PASSED [ 63%]
tests/test_codeql_service.py::TestCodeQLService::test_analyze_repository_not_found PASSED [ 68%]
tests/test_codeql_service.py::TestCodeQLService::test_create_database_timeout PASSED [ 73%]
tests/test_codeql_service.py::TestCodeQLService::test_analyze_timeout PASSED [ 78%]
tests/test_codeql_service.py::TestCodeQLService::test_no_shell_true PASSED [ 84%]
tests/test_codeql_service.py::TestCodeQLService::test_map_severity_unknown PASSED [ 89%]
tests/test_codeql_service.py::TestCodeQLServiceEdgeCases::test_sarif_without_locations PASSED [ 94%]
tests/test_codeql_service.py::TestCodeQLServiceEdgeCases::test_sarif_missing_fields PASSED [100%]
ERROR: Coverage failure: total of 19 is less than fail-under=70


================================== FAILURES ===================================
_____________ TestCodeQLService.test_parse_sarif_severity_mapping _____________
tests\test_codeql_service.py:109: in test_parse_sarif_severity_mapping
    path_injection = next(f for f in findings if "path-injection" in f.rule_id)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   StopIteration
________________ TestCodeQLService.test_parse_sarif_file_paths ________________
tests\test_codeql_service.py:126: in test_parse_sarif_file_paths
    assert "src/database/queries.py" in file_paths
E   AssertionError: assert 'src/database/queries.py' in ['src/db.py', 'src/utils.py', 'src/auth.py']
_______________ TestCodeQLService.test_parse_sarif_line_numbers _______________
tests\test_codeql_service.py:141: in test_parse_sarif_line_numbers
    assert sql_injection.start_line == 125
E   AssertionError: assert 45 == 125
E    +  where 45 = CodeQLFinding(rule_id='py/sql-injection', severity=<SeverityEnum.CRITICAL: 'critical'>, message='Possible SQL injection vector.', file_path='src/db.py', start_line=45, end_line=45, recommendation='SQL Injection\nAvoid building SQL queries with string concatenation. Use parameterized queries instead.').start_line
============================== warnings summary ===============================
config.py:8
  D:\projects\cli\config.py:8: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Settings(BaseSettings):

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=============================== tests coverage ================================
_______________ coverage: platform win32, python 3.13.5-final-0 _______________

Name                            Stmts   Miss  Cover   Missing
-------------------------------------------------------------
api\__init__.py                     2      2     0%   5-7
api\analysis.py                    35     35     0%   6-130
api\ingest.py                      39     39     0%   6-137
api\middleware.py                  36     36     0%   6-105
api\orchestrator.py                60     60     0%   6-247
api\search.py                      45     45     0%   6-153
config.py                          34      0   100%
main.py                            42     42     0%   5-162
models\__init__.py                  1      0   100%
models\requests.py                 44      1    98%   29
models\responses.py                69      0   100%
services\__init__.py                1      0   100%
services\codeql_service.py        113     13    88%   61, 76-77, 123-128, 164, 182, 231-232, 262-263, 352
services\gemini_config.py          14     14     0%   6-79
services\ingest_service.py        185    185     0%   6-477
services\orchestrator.py          105    105     0%   6-330
services\search_service.py         77     77     0%   6-243
test_api.py                        99     99     0%   6-199
test_debug.py                      22     22     0%   2-32
test_search_debug.py               11     11     0%   2-18
tests\__init__.py                   0      0   100%
tests\conftest.py                  33     18    45%   19-21, 31-41, 51-54, 60, 73-74
tests\test_api_integration.py     124    124     0%   6-242
tests\test_codeql_service.py      176      9    95%   110-114, 127-128, 142-147
tests\test_ingest_service.py      159    159     0%   6-351
tests\test_models.py              140    140     0%   6-428
tests\test_search_service.py      167    167     0%   6-355
utils\__init__.py                   6      6     0%   6-12
utils\audit.py                     38     38     0%   6-109
utils\logger.py                    68     68     0%   6-164
utils\metrics.py                   32     32     0%   6-84
utils\rate_limiter.py              43     43     0%   6-113
utils\validators.py               104    104     0%   6-227
verify_system.py                  140    140     0%   6-306
-------------------------------------------------------------
TOTAL                            2264   1834    19%
Coverage HTML written to dir htmlcov
FAIL Required test coverage of 70% not reached. Total coverage: 18.99%
=========================== short test summary info ===========================
FAILED tests/test_codeql_service.py::TestCodeQLService::test_parse_sarif_severity_mapping - StopIteration
FAILED tests/test_codeql_service.py::TestCodeQLService::test_parse_sarif_file_paths - AssertionError: assert 'src/database/queries.py' in ['src/db.py', 'src/utils.py', 'src/auth.py']
FAILED tests/test_codeql_service.py::TestCodeQLService::test_parse_sarif_line_numbers - AssertionError: assert 45 == 125
 +  where 45 = CodeQLFinding(rule_id='py/sql-injection', severity=<SeverityEnum.CRITICAL: 'critical'>, message='Possible SQL injection vector.', file_path='src/db.py', start_line=45, end_line=45, recommendation='SQL Injection\nAvoid building SQL queries with string concatenation. Use parameterized queries instead.').start_line
=================== 3 failed, 16 passed, 1 warning in 1.72s ===================
